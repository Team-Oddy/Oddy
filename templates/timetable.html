{% extends 'base.html' %}
{% block content %}
<h2 class="timetable-top">{{ travel_group.travel_name }} 시간표 보기</h2>

<div class="timetable-container">
    <table class="timetable">
        <thead>
            <tr>
                <th class="timebale-blank"></th>
                {% for date in date_range %}
                <th class="timetable-date">
                    {{ date|date:"m/d" }}<br>
                    {{ date|date:"(D)" }}
                </th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for hour in hours %}
                <tr>
                    <th class="timetable-time">{{ hour }}:00</th>
                    {% for date in date_range %}
                        <td data-date="{{ date|date:'Y-m-d' }}" data-hour="{{ hour }}"></td>
                    {% endfor %}
                </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="pagination">
    {% if has_previous %}
        <button onclick="changePage('{{ previous_page_url }}')" class="timetable-return-btn">이전</button>
    {% endif %}
    {% if has_next %}
        <button onclick="changePage('{{ next_page_url }}')" class="timetable-next-btn">다음</button>
    {% endif %}
</div>

<div class="plan-management">
    <div class="category-buttons">
        <button onclick="showPlans('play')">PLAY</button>
        <button onclick="showPlans('eat')">EAT</button>
        <button onclick="showPlans('stay')">STAY</button>
        <button onclick="showPlans('others')">OTHERS</button>
    </div>
    <div id="plan-list"></div>
</div>

<div id="modify-or-delete-modal" class="modal">
    <div class="modal-content">     
        <img src="/static/image/white-small-cloud.svg" alt="white cloud" width="46.83" height="45.94" class="join_group-white_cloud">
        <h3>여행 계획 관리하기</h3>
        <button onclick="openDateTimeModal(currentPlanId)" class="modal-modify">계획 수정</button>
        <button onclick="confirmDeletePlan(currentPlanId)" class="modal-delete">삭제</button>
        <button onclick="closeModifyOrDeleteModal()">
            
<img src="/static/image/close-btn.svg" alt="close btn" width="31" height="31" class="close-btn">
        </button>
    </div>
</div>

<div id="date-modal" class="modal">
    <div class="modal-content">
        <img src="/static/image/white-small-cloud.svg" alt="white cloud" width="46.83" height="45.94" class="join_group-white_cloud">
        <h3>방문 날짜 선택</h3>
        <div class="date-picker-container">
        <select id="modal-date">
            {% for date in available_dates %}
                <option value="{{ date|date:'Y-m-d' }}">{{ date|date:"Y년 m월 d일" }}</option>
            {% endfor %}
        </select>
        </div>
        <button onclick="openTimeModal()" class="modal-next">다음</button>
        <button onclick="closeDateModal()">
            <img src="/static/image/close-btn.svg" alt="close btn" width="31" height="31" class="close-btn">
        </button>
    </div>
</div>

<div id="time-modal" class="modal">
    <div class="modal-content">
        <h3>방문 시간 입력</h3>
        <label for="modal-start-time">시작 시간:</label>
        <select id="modal-start-time">
            {% for hour in hours %}
                <option value="{{ hour|stringformat:'02d' }}:00">{{ hour }}:00</option>
            {% endfor %}
        </select><br>
        <label for="modal-end-time">종료 시간:</label>
        <select id="modal-end-time">
            {% for hour in hours %}
                <option value="{{ hour|stringformat:'02d' }}:00">{{ hour }}:00</option>
            {% endfor %}
        </select>
        <button onclick="saveDateTimeAndClose()" class="modal-complete">저장</button>
        <button onclick="closeTimeModal()">
        <img src="/static/image/close-btn.svg" alt="close btn" width="31" height="31" class="close-btn">
    </button>
    </div>
</div>

<div id="delete-modal" class="modal">
    <div class="modal-content">
        <h3>이 계획을 시간표에서 제거하시겠습니까?</h3>
        <button onclick="removePlanFromTimetable()">제거</button>
        <button onclick="closeDeleteModal()">취소</button>
    </div>
</div>

<script>
let currentPlanId = null;
let selectedDate = null;

document.addEventListener('DOMContentLoaded', function() {
    loadAllPlans();
});

function openModifyOrDeleteModal(planId) {
    currentPlanId = planId;
    document.getElementById('modify-or-delete-modal').style.display = 'block';
}

function closeModifyOrDeleteModal() {
    document.getElementById('modify-or-delete-modal').style.display = 'none';
}

function openDateTimeModal(planId) {
    currentPlanId = planId;
    document.getElementById('date-modal').style.display = 'block';
    closeModifyOrDeleteModal();
}

function closeDateModal() {
    document.getElementById('date-modal').style.display = 'none';
}

function openTimeModal() {
    selectedDate = document.getElementById('modal-date').value;
    document.getElementById('date-modal').style.display = 'none';
    document.getElementById('time-modal').style.display = 'block';
}

function closeTimeModal() {
    document.getElementById('time-modal').style.display = 'none';
}

function saveDateTimeAndClose() {
    const startTime = document.getElementById('modal-start-time').value;
    const endTime = document.getElementById('modal-end-time').value;
    
    if (!startTime || !endTime) {
        alert('시간을 입력해주세요.');
        return;
    }
    if (startTime >= endTime) {
        alert('시작 시간은 종료 시간보다 이르게 설정해주세요.');
        return;
    }

    fetch("{% url 'plans:update_plan_datetime' %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            plan_id: currentPlanId,
            date: selectedDate,
            plan_start_time: startTime,
            plan_end_time: endTime
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            closeTimeModal();
            updatePlanInTimetable(data.old_plan, data.new_plan);
            showPlans(data.category);
        }
    });
}

function confirmDeletePlan(planId) {
    currentPlanId = planId;
    document.getElementById('delete-modal').style.display = 'block';
    closeModifyOrDeleteModal();
}

function closeDeleteModal() {
    document.getElementById('delete-modal').style.display = 'none';
}

function removePlanFromTimetable() {
    fetch("{% url 'plans:update_plan_datetime' %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            plan_id: currentPlanId,
            date: null,
            plan_start_time: null,
            plan_end_time: null
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            closeDeleteModal();
            updatePlanInTimetable(data.old_plan, data.new_plan);
            showPlans(data.category);
        }
    });
}

function loadAllPlans() {
    fetch("{% url 'plans:get_all_plans' travel_group.id %}")
    .then(response => response.json())
    .then(plans => {
        clearTimetable();
        plans.forEach(addPlanToTimetable);
    });
}

function clearTimetable() {
    const cells = document.querySelectorAll('.timetable td');
    cells.forEach(cell => {
        cell.innerHTML = '';
        cell.style.display = '';
        cell.rowSpan = 1;
    });
}

function updatePlanInTimetable(oldPlan, newPlan) {
    if (oldPlan.date && oldPlan.plan_start_time && oldPlan.plan_end_time) {
        removePlanElementFromTimetable(oldPlan);
    }
    
    if (newPlan.date && newPlan.plan_start_time && newPlan.plan_end_time) {
        addPlanToTimetable(newPlan);
    }
}

function removePlanElementFromTimetable(plan) {
    const startHour = parseInt(plan.plan_start_time.split(':')[0]);
    const endHour = parseInt(plan.plan_end_time.split(':')[0]);

    for (let hour = startHour; hour <= endHour; hour++) {
        const cell = document.querySelector(`td[data-date="${plan.date}"][data-hour="${hour}"]`);
        if (cell) {
            const planElements = cell.querySelectorAll(`.plan`);
            planElements.forEach(element => {
                if (element.textContent.includes(plan.place)) {
                    element.remove();
                }
            });
            
            if (hour === startHour) {
                cell.rowSpan = 1;
            } else {
                cell.style.display = '';
            }
        }
    }
}

function addPlanToTimetable(plan) {
    if (plan.date && plan.plan_start_time && plan.plan_end_time) {
        const startHour = parseInt(plan.plan_start_time.split(':')[0]);
        const endHour = parseInt(plan.plan_end_time.split(':')[0]);

        const cell = document.querySelector(`td[data-date="${plan.date}"][data-hour="${startHour}"]`);
        if (cell) {
            const planElement = document.createElement('div');
            planElement.textContent = `${plan.place}`;
            planElement.className = `plan ${plan.category}`;
            planElement.onclick = function() { openModifyOrDeleteModal(plan.id); };

            const duration = endHour - startHour;
            cell.rowSpan = duration + 1;
            cell.appendChild(planElement);

            for (let hour = startHour + 1; hour <= endHour; hour++) {
                const nextCell = document.querySelector(`td[data-date="${plan.date}"][data-hour="${hour}"]`);
                if (nextCell) {
                    nextCell.style.display = 'none';
                }
            }
        }
    }
}

function showPlans(category) {
    fetch("{% url 'plans:get_plans' travel_group.id %}?category=" + category)
    .then(response => response.json())
    .then(plans => {
        console.log(plans)
        const planList = document.getElementById('plan-list');
        planList.innerHTML = '';
        plans.forEach(plan => {
            const planElement = document.createElement('div');
            planElement.className = 'plan-item';
            const showAirplaneText = plan.date && plan.plan_start_time && plan.plan_end_time;
            planElement.innerHTML = `
                <p>유형: ${category.toUpperCase()}</p>
                <p>작성자: ${plan.creator}</p>
                <p>장소: ${plan.place}</p>
                <p>설명: ${plan.description}</p>
                <p>좋아요 개수: ${plan.like_count || 0}</p>
                ${showAirplaneText ? '<p>비행기</p>' : ''}
            `;

            // "비행기" 글자가 표시되면 서버에 요청하여 데이터베이스 업데이트
            if (showAirplaneText) {
                saveAirplaneTextToDB(plan.id);
            }

            planElement.onclick = () => openDateTimeModal(plan.id);
            planList.appendChild(planElement);
        });
    });
}

function saveAirplaneTextToDB(planId) {
    fetch("{% url 'plans:save_airplane_text' %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            plan_id: planId,
            airplane_text: '비행기'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            console.log('Successfully saved airplane text for plan:', planId);
        } else {
            console.error('Failed to save airplane text:', data.message);
        }
    });
}


function changePage(url) {
    window.location.href = url;
}
</script>
{% endblock %}