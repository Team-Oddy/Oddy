{% extends 'base.html' %}
{% load static %}

{% block title %}Oddy{% endblock %}

{% block content %}
<style>
    .travelgroup-container {
        display: flex;
        overflow-x: auto; /* 가로 스크롤 활성화 */
        gap: 10px;
        position: relative;
        width: 325px;
        left: 34px;
    }

    .now-travelgroup-container {
        top: 325px; /* 진행 중인 여행 모임의 top */
    }

    .past-travelgroup-container {
        top: 412px; /* 종료된 여행 모임의 top */
    }

    .travelgroup-ul {
        display: flex;
        flex-wrap: nowrap; /* 가로로 나열 */
        gap: 10px;
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .travelgroup-ul li {
        font: var(----text-style-pretendard-semibold-20);
        width: 82px;
        height: 103px;
        border-radius: 10px;
        background: #D9D9D9;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        color: var(--blue02);
        flex-shrink: 0; /* 크기 조정 방지 */
    }

    .add-group-btn {
        width: 82px;
        height: 103px;
        border-radius: 10px;
        background: #D9D9D9;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .mypage-plus {
        width: 30.128px;
        height: 30.128px;
    }

    .mp-ongoing-btn {
        color: var(--blue02);
        text-decoration: none;
    }
</style>

<div id="profilePage">
    <span class="my-page-top">마이페이지</span> 
    <img src="{% static 'image/pink-half-cloud.svg' %}" alt="pink cloud" width="82.87" height="81.3" class="my-page-pink_cloud"> 
    <div>
        <p id="userName">{{ user_profile.nickname }}</p>
    </div>

    <div>
        <div class="my-page-container"></div>
        <a href="{% url 'plans:kakao_logout' %}" class="logout-btn">
            <span>로그아웃</span></a><br>
        <div class="modify-nickname-container">
        <a href="javascript:void(0);" onclick="nicknameEdit()" class="modify-nickname">닉네임 수정</a><br>
        </div>
        <a href="javascript:void(0);" onclick="showTravelType()" class="checktraveltype">나의 여행 유형 확인하기</a><br>
    </div>

    <!-- 진행 중인 여행 모임 섹션 -->
    <div>
        <h2 class="now-travelgroup">진행중인 여행 모임</h2>
        <div class="travelgroup-container now-travelgroup-container">
            <ul class="travelgroup-ul">
                {% if ongoing_travel_groups %}
                    {% for group in ongoing_travel_groups %}
                    <li>
                        <a href="{% url 'plans:view_travel_group' travel_group_id=group.id %}" class="mp-ongoing-btn">{{ group.travel_name }}</a>
                    </li>
                    {% endfor %}
                {% endif %}
                <!-- 새로운 여행 모임 추가 버튼 -->
                <li>
                    <a href="{% url 'plans:create_group' %}" class="add-group-btn">
                        <img src="{% static 'image/mypage_plus.svg' %}" alt="plus btn" class="mypage-plus">
                    </a>
                </li>
            </ul>
        </div>
    </div>

    <!-- 종료된 여행 모임 섹션 -->
    <div>
        <h2 class="past-travelgroup">종료된 여행 모임</h2>
        <div class="travelgroup-container past-travelgroup-container">
            <ul class="travelgroup-ul">
                {% if past_travel_groups %}
                    {% for group in past_travel_groups %}
                        <li>{{ group.travel_name }}</li>
                    {% endfor %}
                {% endif %}
            </ul>
        </div>
    </div>
</div>

<!-- 여행 유형 결과 표시 -->
<div id="travelTypeResult" style="display:none;">
    <div class="testResult-top">
        <p>나의 여행 유형</p>
    </div>
    {% if user_profile.travel_type == '완벽주의 플래너형' %}
        <!-- 여행 유형에 따른 결과 표시 -->
    {% endif %}
    <a href="{% url 'plans:test' %}" class="testResult-restart">다시 할래요</a>
    <button class="testResult-button" onclick="hideTravelType()">확인</button>
</div>

<!-- 닉네임 수정 -->
<div id="nicknameEditPage" style="display:none;">
    <span class="nicknameedit-top">닉네임 수정</span>
    <h2 class="nicknameedit-text">수정할 닉네임을 알려주세요!</h2><br>
    <input type="text" id="nicknameInput" placeholder="닉네임을 입력하세요 0/5" value="{{ user_profile.nickname }}"><br>
    <p id="nicknameError" style="display: none;">5자 이내로 작성해주세요!</p><br>
    <button id="nicknameSubmitButton" onclick="submitNickname()" class="nicknameedit-complete-btn" disabled><span>완료</span></button><br>
    <button type="button" onclick="showProfilePage()">
        <img src="{% static 'image/chevron-left.svg' %}" alt="back-btn" width="18" height="18" class="back-btn"> 
    </button>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const nicknameInput = document.getElementById('nicknameInput');
        const submitButton = document.getElementById('nicknameSubmitButton');

        nicknameInput.addEventListener('input', function() {
            checkNickname();
        });

        function checkNickname() {
            if (nicknameInput.value.trim() !== '') {
                submitButton.classList.add('active');
                submitButton.disabled = false;
            } else {
                submitButton.classList.remove('active');
                submitButton.disabled = true;
            }
        }
    });

    function nicknameEdit() {
        document.getElementById('profilePage').style.display = 'none';
        document.getElementById('nicknameEditPage').style.display = 'block';
    }
    
    function showProfilePage() {
        document.getElementById('profilePage').style.display = 'block';
        document.getElementById('nicknameEditPage').style.display = 'none';
    }

    function showTravelType() {
        const travelType = "{{ user_profile.travel_type|escapejs }}";
        if (!travelType || travelType === 'None' || travelType.trim() === '') {
            alert('여행 유형 테스트를 진행해 주세요!');
            return;
        }
        document.getElementById('profilePage').style.display = 'none';
        document.getElementById('travelTypeResult').style.display = 'block';
    }

    function hideTravelType() {
        document.getElementById('profilePage').style.display = 'block';
        document.getElementById('travelTypeResult').style.display = 'none';
    }

    function submitNickname() {
        const nickname = document.getElementById('nicknameInput').value;
        if (nickname.length > 5) {
            document.getElementById('nicknameError').style.display = 'block';
            return;
        }

        fetch("{% url 'plans:update_nickname' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                nickname: nickname
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('userName').innerText = nickname;
                showProfilePage();
            } else {
                document.getElementById('nicknameError').innerText = data.error;
                document.getElementById('nicknameError').style.display = 'block';
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }
</script>
{% endblock %}
