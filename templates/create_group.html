{% extends 'base.html' %}
{% load static %}

{% block title %}Oddy-create_group{% endblock %}

{% block content %}

<div id="createGroupPage" class="create_group-page create_group-active">
    <h2>닉네임을 알려주세요!</h2><br>
    <input type="text" id="nickname" placeholder="닉네임을 입력하세요 0/5"><br>
    <p id="nicknameError" class="create_group-error">닉네임은 5글자 이내로 작성해주세요.</p><br>
    <button onclick="nextStep('nickname', 'optionsPage')">완료</button><br>
    <p>나중에 만드시겠어요? <a href="{% url 'plans:main' %}">나가기</a></p>
</div>

<div id="optionsPage" class="create_group-page">
    <button onclick="showPage('travelNamePage')">여행 모임 만들기</button><br>
    <button onclick="showPage('joinGroupPage')">초대받은 여행 모임 입장하기</button>
</div>

<div id="travelNamePage" class="create_group-page">
    <h2>여행 모임 생성하기</h2>
    <h3>여행 이름을 알려주세요!</h3><br>
    <input type="text" id="travelName" placeholder="여행 이름을 입력하세요 0/15"><br>
    <p id="travelNameError" class="create_group-error">여행 이름은 15글자 이내로 작성해주세요.</p><br>
    <button onclick="nextStep('travelName', 'travelDatePage')">다음</button><br>
    <p>나중에 만드시겠어요? <a href="{% url 'plans:main' %}">나가기</a></p>
</div>

<div id="travelDatePage" class="create_group-page">
    <button onclick="showPage('travelNamePage')">이전</button><br>
    <h2>여행 모임 생성하기</h2>
    <h3>여행 일정을 알려주세요!</h3><br>
    <input type="text" id="travelStartDate" placeholder="2024/07/31"> - <input type="text" id="travelEndDate" placeholder="2024/07/31"><br>
    <p id="travelDateError" class="create_group-error">여행 시작일과 종료일을 모두 입력해주세요.</p><br>
    <button onclick="nextStepDates('travelStartDate', 'travelEndDate')">완료</button><br>
    <p>나중에 만드시겠어요? <a href="{% url 'plans:main' %}">나가기</a></p>
</div>

<div id="completePage" class="create_group-page">
    <h2>여행 모임 생성이 완료되었습니다!</h2><br>
    <a href="#">초대코드 생성하기</a><br>
    <button onclick="showPage('entryPage')">여행 모임 입장하기</button>
</div>

<div id="entryPage" class="create_group-page">
    <a href="{% url 'plans:test' %}">여행 유형 테스트 진행하기</a>
</div>

<div id="joinGroupPage" class="create_group-page">
    <h2>초대 코드 입력하기</h2><br>
    <input type="text" id="inviteCode" placeholder="초대 코드 6자리를 입력해주세요"><br>
    <p id="inviteCodeError" class="create_group-error">초대 코드는 6자리 숫자로 입력해주세요.</p><br>
    <button onclick="nextStep('inviteCode', 'joinCompletePage')">완료</button><br>
</div>

<div id="joinCompletePage" class="create_group-page">
    <button onclick="showPage('entryPage')">여행 모임 입장하기</button>
</div>

<script>
let formData = {};

function showPage(pageId) {
    document.querySelectorAll('.create_group-page').forEach(page => page.classList.remove('create_group-active'));
    document.getElementById(pageId).classList.add('create_group-active');
    document.querySelectorAll('.create_group-error').forEach(error => error.style.display = 'none'); // 페이지 전환 시 에러 메시지 숨기기
}

function nextStep(inputId, nextPageId) {
    let value = document.getElementById(inputId).value;
    if (value.trim() === "") {
        return;
    }
    if (inputId === 'nickname' && value.length > 5) {
        document.getElementById('nicknameError').style.display = 'block'; 
        return;
    }
    if (inputId === 'travelName' && value.length > 15) {
        document.getElementById('travelNameError').style.display = 'block'; 
        return;
    }
    formData[inputId] = value;

    if (inputId === 'nickname') {
        submitNickname();
    } else if (nextPageId === 'travelDatePage') {
        showPage(nextPageId);
    } else {
        showPage(nextPageId);
    }
}

function nextStepDates(startInputId, endInputId) {
    let startValue = document.getElementById(startInputId).value;
    let endValue = document.getElementById(endInputId).value;
    if (startValue.trim() === "" || endValue.trim() === "") {
        document.getElementById('travelDateError').style.display = 'block'; 
        return;  
    }
    formData[startInputId] = startValue;
    formData[endInputId] = endValue;

    // 여행 정보 저장
    submitTravelInfo();
}

// CSRF 토큰을 가져오는 함수
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// 폼 데이터를 서버로 전송하는 함수
function submitNickname() {
    fetch('/create_group/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({nickname: formData.nickname})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showPage('optionsPage');
        } else {
            alert(data.error);
        }
    });
}

function submitTravelInfo() {
    const startDate = new Date(formData.travelStartDate);
    const endDate = new Date(formData.travelEndDate);

    fetch('/travel_name_page/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            travelName: formData.travelName,
            travelStartDate: startDate.toISOString().split('T')[0],
            travelEndDate: endDate.toISOString().split('T')[0]
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showPage('completePage');
        } else {
            alert(data.error);
        }
    });
}
</script>
{% endblock %}